<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Popup Behavior Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }

      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .popup-frame {
        border: 2px solid #ccc;
        border-radius: 12px;
        overflow: hidden;
        display: inline-block;
        background: white;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }

      .pass {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .fail {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .dimensions-test {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .dimension-box {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        min-width: 100px;
      }

      iframe {
        border: none;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>ChromCognito Popup Behavior Test</h1>

    <div class="test-container">
      <h2>1. Popup Dimensions Test</h2>
      <div class="dimensions-test">
        <div class="dimension-box">
          <strong>Target Width:</strong><br />
          320px
        </div>
        <div class="dimension-box">
          <strong>Max Height:</strong><br />
          600px
        </div>
        <div class="dimension-box">
          <strong>Header Height:</strong><br />
          60px
        </div>
      </div>

      <div class="popup-frame" style="width: 320px; height: 400px">
        <iframe
          src="dist/src/popup/index.html"
          width="320"
          height="400"
          id="popup-iframe"
        ></iframe>
      </div>

      <div id="dimension-results"></div>
    </div>

    <div class="test-container">
      <h2>2. Overflow Handling Test</h2>
      <p>Testing popup with constrained height to verify scrolling behavior:</p>

      <div class="popup-frame" style="width: 320px; height: 300px">
        <iframe
          src="dist/src/popup/index.html"
          width="320"
          height="300"
          id="overflow-iframe"
        ></iframe>
      </div>

      <div id="overflow-results"></div>
    </div>

    <div class="test-container">
      <h2>3. Responsive Behavior Test</h2>
      <p>Testing popup at different viewport sizes:</p>

      <div style="display: flex; gap: 20px; flex-wrap: wrap">
        <div>
          <h4>Standard (320px)</h4>
          <div class="popup-frame" style="width: 320px; height: 400px">
            <iframe
              src="dist/src/popup/index.html"
              width="320"
              height="400"
            ></iframe>
          </div>
        </div>

        <div>
          <h4>Narrow (280px)</h4>
          <div class="popup-frame" style="width: 280px; height: 400px">
            <iframe
              src="dist/src/popup/index.html"
              width="280"
              height="400"
            ></iframe>
          </div>
        </div>

        <div>
          <h4>Short (320x300)</h4>
          <div class="popup-frame" style="width: 320px; height: 300px">
            <iframe
              src="dist/src/popup/index.html"
              width="320"
              height="300"
            ></iframe>
          </div>
        </div>
      </div>

      <div id="responsive-results"></div>
    </div>

    <div class="test-container">
      <h2>4. Browser Extension Constraints Test</h2>
      <div id="constraints-results"></div>
    </div>

    <div class="test-container">
      <h2>5. Interactive Elements Test</h2>
      <div id="interaction-results"></div>
    </div>

    <script>
      // Test popup dimensions and constraints
      function runDimensionTests() {
        const results = document.getElementById("dimension-results");
        const tests = [];

        // Test CSS variables are properly set
        const iframe = document.getElementById("popup-iframe");

        iframe.onload = function () {
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;
            const computedStyle = iframe.contentWindow.getComputedStyle(
              iframeDoc.documentElement,
            );

            const popupWidth = computedStyle
              .getPropertyValue("--popup-width")
              .trim();
            const popupMaxHeight = computedStyle
              .getPropertyValue("--popup-max-height")
              .trim();
            const headerHeight = computedStyle
              .getPropertyValue("--header-height")
              .trim();

            tests.push({
              name: "CSS Variable --popup-width",
              expected: "320px",
              actual: popupWidth,
              pass: popupWidth === "320px",
            });

            tests.push({
              name: "CSS Variable --popup-max-height",
              expected: "600px",
              actual: popupMaxHeight,
              pass: popupMaxHeight === "600px",
            });

            tests.push({
              name: "CSS Variable --header-height",
              expected: "60px",
              actual: headerHeight,
              pass: headerHeight === "60px",
            });

            // Test actual popup element dimensions
            const popupElement = iframeDoc.querySelector(".chronow-popup");
            if (popupElement) {
              const rect = popupElement.getBoundingClientRect();

              tests.push({
                name: "Popup Element Width",
                expected: "320px",
                actual: `${Math.round(rect.width)}px`,
                pass: Math.abs(rect.width - 320) < 5,
              });

              tests.push({
                name: "Popup Element Max Height Constraint",
                expected: "≤ 600px",
                actual: `${Math.round(rect.height)}px`,
                pass: rect.height <= 600,
              });
            }

            displayResults(results, tests);
          } catch (error) {
            results.innerHTML = `<div class="fail">Error accessing iframe content: ${error.message}</div>`;
          }
        };
      }

      function runOverflowTests() {
        const results = document.getElementById("overflow-results");
        const iframe = document.getElementById("overflow-iframe");

        iframe.onload = function () {
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;
            const tests = [];

            // Check if scrollable containers have proper overflow handling
            const contentElement = iframeDoc.querySelector(".chronow-content");
            const recentlyClosedContainer = iframeDoc.querySelector(
              ".recently-closed-container",
            );

            if (contentElement) {
              const contentStyle =
                iframe.contentWindow.getComputedStyle(contentElement);
              tests.push({
                name: "Main Content Overflow Y",
                expected: "auto",
                actual: contentStyle.overflowY,
                pass: contentStyle.overflowY === "auto",
              });

              tests.push({
                name: "Main Content Overflow X",
                expected: "hidden",
                actual: contentStyle.overflowX,
                pass: contentStyle.overflowX === "hidden",
              });
            }

            if (recentlyClosedContainer) {
              const containerStyle = iframe.contentWindow.getComputedStyle(
                recentlyClosedContainer,
              );
              tests.push({
                name: "Recently Closed Container Overflow Y",
                expected: "auto",
                actual: containerStyle.overflowY,
                pass: containerStyle.overflowY === "auto",
              });

              // Check scrollbar styling
              tests.push({
                name: "Scrollbar Width",
                expected: "thin or custom",
                actual: containerStyle.scrollbarWidth || "webkit-custom",
                pass:
                  containerStyle.scrollbarWidth === "thin" ||
                  containerStyle.scrollbarWidth === "auto",
              });
            }

            displayResults(results, tests);
          } catch (error) {
            results.innerHTML = `<div class="fail">Error testing overflow: ${error.message}</div>`;
          }
        };
      }

      function runConstraintsTests() {
        const results = document.getElementById("constraints-results");
        const tests = [];

        // Test manifest.json popup configuration
        fetch("dist/manifest.json")
          .then((response) => response.json())
          .then((manifest) => {
            tests.push({
              name: "Manifest Default Popup",
              expected: "src/popup/index.html",
              actual: manifest.action.default_popup,
              pass: manifest.action.default_popup === "src/popup/index.html",
            });

            tests.push({
              name: "Manifest Version",
              expected: "3",
              actual: manifest.manifest_version.toString(),
              pass: manifest.manifest_version === 3,
            });

            // Test popup HTML structure
            return fetch("dist/src/popup/index.html");
          })
          .then((response) => response.text())
          .then((html) => {
            tests.push({
              name: "Popup HTML has root div",
              expected: "true",
              actual: html.includes('<div id="root">').toString(),
              pass: html.includes('<div id="root">'),
            });

            tests.push({
              name: "Popup HTML has CSS link",
              expected: "true",
              actual: html.includes("index.css").toString(),
              pass: html.includes("index.css"),
            });

            tests.push({
              name: "Popup HTML has JS module",
              expected: "true",
              actual: html.includes("popup.js").toString(),
              pass: html.includes("popup.js"),
            });

            displayResults(results, tests);
          })
          .catch((error) => {
            results.innerHTML = `<div class="fail">Error testing constraints: ${error.message}</div>`;
          });
      }

      function runInteractionTests() {
        const results = document.getElementById("interaction-results");
        const tests = [];

        // Test that all required interactive elements are present
        const iframe = document.getElementById("popup-iframe");

        setTimeout(() => {
          try {
            const iframeDoc =
              iframe.contentDocument || iframe.contentWindow.document;

            // Check for header buttons
            const refreshButton = iframeDoc.querySelector(
              'button[aria-label="Refresh"]',
            );
            const settingsButton = iframeDoc.querySelector(
              'button[aria-label="Settings"]',
            );

            tests.push({
              name: "Refresh Button Present",
              expected: "true",
              actual: (!!refreshButton).toString(),
              pass: !!refreshButton,
            });

            tests.push({
              name: "Settings Button Present",
              expected: "true",
              actual: (!!settingsButton).toString(),
              pass: !!settingsButton,
            });

            // Check for main action buttons
            const actionButtons =
              iframeDoc.querySelectorAll(".button-group .btn");
            tests.push({
              name: "Action Buttons Count",
              expected: "≥ 3",
              actual: actionButtons.length.toString(),
              pass: actionButtons.length >= 3,
            });

            // Check for proper button styling
            if (actionButtons.length > 0) {
              const firstButton = actionButtons[0];
              const buttonStyle =
                iframe.contentWindow.getComputedStyle(firstButton);

              tests.push({
                name: "Button Min Height",
                expected: "48px",
                actual: buttonStyle.minHeight,
                pass: buttonStyle.minHeight === "48px",
              });

              tests.push({
                name: "Button Border Radius",
                expected: "8px",
                actual: buttonStyle.borderRadius,
                pass: buttonStyle.borderRadius === "8px",
              });
            }

            // Check for accessibility attributes
            const focusableElements = iframeDoc.querySelectorAll(
              "button, a, [tabindex]",
            );
            let accessibleCount = 0;
            focusableElements.forEach((el) => {
              if (
                el.getAttribute("aria-label") ||
                el.getAttribute("title") ||
                el.textContent.trim()
              ) {
                accessibleCount++;
              }
            });

            tests.push({
              name: "Accessible Interactive Elements",
              expected: `${focusableElements.length}`,
              actual: accessibleCount.toString(),
              pass: accessibleCount === focusableElements.length,
            });

            displayResults(results, tests);
          } catch (error) {
            results.innerHTML = `<div class="fail">Error testing interactions: ${error.message}</div>`;
          }
        }, 2000); // Wait for React to render
      }

      function runResponsiveTests() {
        const results = document.getElementById("responsive-results");
        const tests = [];

        // Test responsive breakpoints
        tests.push({
          name: "CSS Media Query for Small Screens",
          expected: "Present",
          actual: "Checking...",
          pass: true, // Will be updated by CSS check
        });

        // Check if CSS contains responsive rules
        fetch("dist/assets/index.css")
          .then((response) => response.text())
          .then((css) => {
            const hasSmallScreenQuery = css.includes(
              "@media (max-width: 320px)",
            );
            const hasShortScreenQuery = css.includes(
              "@media (max-height: 400px)",
            );

            tests[0].actual = hasSmallScreenQuery ? "Found" : "Not Found";
            tests[0].pass = hasSmallScreenQuery;

            tests.push({
              name: "CSS Media Query for Short Screens",
              expected: "Present",
              actual: hasShortScreenQuery ? "Found" : "Not Found",
              pass: hasShortScreenQuery,
            });

            displayResults(results, tests);
          })
          .catch((error) => {
            results.innerHTML = `<div class="fail">Error testing responsive CSS: ${error.message}</div>`;
          });
      }

      function displayResults(container, tests) {
        container.innerHTML = tests
          .map(
            (test) =>
              `<div class="test-result ${test.pass ? "pass" : "fail"}">
                    <strong>${test.name}:</strong> 
                    Expected: ${test.expected}, 
                    Actual: ${test.actual}
                    ${test.pass ? " ✓" : " ✗"}
                </div>`,
          )
          .join("");
      }

      // Run all tests when page loads
      window.onload = function () {
        setTimeout(() => {
          runDimensionTests();
          runOverflowTests();
          runConstraintsTests();
          runInteractionTests();
          runResponsiveTests();
        }, 1000);
      };
    </script>
  </body>
</html>
